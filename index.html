<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚­ãƒ©ã‚­ãƒ©æŠ½é¸â˜†ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound generation (Drum Roll & BGM) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* èƒŒé¢ã‚’ãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼ã«ã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
        body {
            background-color: #e0f7fa; /* ãƒ‘ã‚¹ãƒ†ãƒ«æ°´è‰² */
            background-image: 
                repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.3) 0, rgba(255, 255, 255, 0.3) 2px, transparent 2px, transparent 10px),
                repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0.3) 0, rgba(255, 255, 255, 0.3) 2px, transparent 2px, transparent 10px);
            padding-bottom: 50px;
            position: relative;
            overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ç¦æ­¢ */
        }

        /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæœ¬ä½“ã®ã‚«ã‚¹ã‚¿ãƒ CSS - å½±ã‚’å¤–ã—æ ç·šãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´ */
        .wheel-container {
            position: relative;
            width: 450px; /* åˆæœŸå€¤ã¨ã—ã¦ä¿®æ­£ */
            height: 450px; /* åˆæœŸå€¤ã¨ã—ã¦ä¿®æ­£ */
            margin: 40px auto;
            border-radius: 50%;
            /* æ ã®ã‚ˆã†ãªãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´: äºŒé‡ã®ãƒœãƒ¼ãƒ€ãƒ¼ã¨è–„ã„å½± */
            border: 8px solid #f8bbd0; /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ”ãƒ³ã‚¯ã®å¤ªã„æ  */
            box-shadow: 0 0 0 5px #ffffff, 0 10px 30px rgba(0, 0, 0, 0.15); /* ç™½ã„å†…æ ã¨å¤–å´ã®å½± */
            background-color: #ffffff;
            transition: width 0.3s, height 0.3s; /* ã‚µã‚¤ã‚ºå¤‰æ›´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            /* transitionæ™‚é–“ã¯JavaScriptã§å‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ */
            transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            position: relative;
        }

        /* çŸ¢å°ï¼ˆãƒã‚¤ãƒ³ã‚¿ãƒ¼ï¼‰ */
        .pointer {
            position: absolute;
            top: 0; /* ã‚³ãƒ³ãƒ†ãƒŠã®ä¸Šç«¯ã«é…ç½® */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #d9534f; /* â–¼ã‚’ä¸‹å‘ãã«å¤‰æ›´ */
            z-index: 10;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }

        /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ä¸­å¿ƒã‚’é£¾ã‚‹å†† */
        #wheel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background-color: #fff;
            border: 3px solid #d9534f;
            border-radius: 50%;
            z-index: 5;
        }

        /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå†…ã®ãƒ©ãƒ™ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
        .label-container {
            position: absolute;
            inset: 0;
        }

        /* ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .wheel-label-text {
            /* ä¸­å¤®ã‹ã‚‰å¤–å´ã«ãšã‚‰ã—ãŸä½ç½® */
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%; 
            height: 1.5rem; 
            transform-origin: 0% 50%; 
        }

        .result-animate {
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

    </style>
</head>
<body class="p-5 flex flex-col items-center font-sans">

    <div class="max-w-4xl w-full">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">ğŸ¶ ã‚­ãƒ©ã‚­ãƒ©æŠ½é¸â˜†ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ ğŸ±</h1>
        
        <!-- èª¬æ˜/ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-8 rounded-lg shadow-md">
            <p class="font-semibold">ğŸ’¡ ä½¿ã„æ–¹:</p>
            <ul class="list-disc list-inside ml-4 text-sm">
                <li>**ä¾‹ã§è¡¨ç¤ºã—ã¦ã„ã‚‹åå‰ã‚’å‚åŠ è€…ã®åå‰ã«æ›¸ãæ›¿ãˆã¾ã—ã‚‡ã†**ã€‚ã™ãã«ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆï¼ã€ã‚’æŠ¼ã›ã¾ã™ã€‚</li>
                <li>å…¥åŠ›å€¤ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ä¸Šæ›¸ãã™ã‚‹ã‹å‰Šé™¤ã—ã¦ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’æº–å‚™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</li>
            </ul>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
            
            <div class="flex-1 bg-white p-6 rounded-xl shadow-lg">
                <label for="names" class="block text-lg font-bold text-gray-700 mb-2">ğŸ“ å‚åŠ è€…å è²¼ã‚Šä»˜ã‘æ¬„</label>
                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§10åã®ä»®ã®åå‰ã‚’æŒ¿å…¥ -->
                <textarea id="names" class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-gray-800">å¤ªéƒ
èŠ±å­
æ¬¡éƒ
ä¸‰éƒ
ç”±ç¾
å¥å¤ª
ã•ã‚„ã‹
å’Œæ¨¹
ç¾å’²
å¤§è¼”</textarea>
                <p class="text-xs text-gray-500 mt-1">â€»æœ€å¤§50åç¨‹åº¦æ¨å¥¨ã€‚ä¸Šè¨˜ã¯ä»®ã®åå‰ã§ã™ã€‚</p>
            </div>

            <div class="flex-1 bg-white p-6 rounded-xl shadow-lg">
                <label for="weights" class="block text-lg font-bold text-gray-700 mb-2">âœ–ï¸ å€ç‡ è²¼ã‚Šä»˜ã‘æ¬„ (æ•°å­—)</label>
                <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å€ç‡1ã‚’æŒ¿å…¥ -->
                <textarea id="weights" class="w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-gray-800">1
1
1
1
1
1
1
1
1
1</textarea>
                <p class="text-xs text-gray-500 mt-1">â€»0ã‚ˆã‚Šå¤§ãã„æ•´æ•°ã‚’å…¥åŠ›ã€‚ä¸Šè¨˜ã¯ä»®ã®å€ç‡ã§ã™ã€‚</p>
            </div>

        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
            <div class="flex flex-col items-center w-full md:w-1/3 p-4 bg-white rounded-xl shadow-inner">
                <label for="sizeSlider" class="text-sm font-semibold text-gray-600 mb-2">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºèª¿æ•´</label>
                <!-- onclickå±æ€§ã‚’å‰Šé™¤ -->
                <input type="range" id="sizeSlider" min="200" max="600" value="450" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                <span id="currentSize" class="text-xs text-gray-500 mt-1">450px</span>
            </div>

            <!-- onclickå±æ€§ã‚’å‰Šé™¤ -->
            <button id="prepareButton" class="w-full md:w-1/3 px-8 py-3 bg-pink-500 text-white font-bold rounded-xl shadow-lg hover:bg-pink-600 transition duration-150 transform hover:scale-105">
                ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’æº–å‚™
            </button>
            <!-- onclickå±æ€§ã‚’å‰Šé™¤ -->
            <button id="spinButton" disabled class="w-full md:w-1/3 px-8 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆï¼
            </button>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’HTMLå´ã§è¨­å®š -->
        <div id="result" class="text-3xl font-extrabold text-center text-gray-700 min-h-[40px] mb-4 p-4 bg-yellow-100 rounded-xl shadow-inner">
            ä¾‹ã§è¡¨ç¤ºã—ã¦ã„ã‚‹åå‰ã‚’å‚åŠ è€…ã®åå‰ã«æ›¸ãæ›¿ãˆã¾ã—ã‚‡ã†ã€‚
        </div>

        <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæœ¬ä½“ã¨ãƒã‚¤ãƒ³ã‚¿ãƒ¼ -->
        <div id="wheelContainer" class="wheel-container">
            <div class="pointer"></div>
            <div id="wheel">
                <!-- Conic Gradientã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®åŒºç”»ã¨ãƒ©ãƒ™ãƒ«ãŒã“ã“ã«æç”»ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- ğŸ† éå»ã®å½“é¸è€…ãƒªã‚¹ãƒˆã‚’è¿½åŠ  -->
        <div id="historyContainer" class="mt-8 bg-white p-6 rounded-xl shadow-lg w-full">
            <h3 class="text-xl font-bold text-gray-700 mb-3">ğŸ† éå»ã®å½“é¸è€…ãƒªã‚¹ãƒˆ</h3>
            <ul id="winnerHistory" class="list-disc list-inside space-y-1 text-gray-600">
                <!-- History items will go here -->
            </ul>
            <!-- onclickå±æ€§ã‚’å‰Šé™¤ -->
            <button id="resetButton" class="mt-4 px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg shadow hover:bg-yellow-600 disabled:opacity-50 disabled:cursor-not-allowed">
                å½“é¸è€…ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </div>

    <!-- å®£ä¼ãƒ•ãƒƒã‚¿ãƒ¼ã®è¿½åŠ  -->
    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>æä¾›ï¼š<a href="https://www.pcshop-ige.com/" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline">PC-SHOP IGE</a></p>
    </footer>


    <script>
        // IIFEæ§‹é€ ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥scriptã‚¿ã‚°å†…ã§å®Ÿè¡Œã—ã¾ã™ã€‚
        // ã“ã‚Œã«ã‚ˆã‚Šã€WordPressã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼ã«ã‚ˆã‚‹æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãã¾ã™ã€‚
        
        // DOMè¦ç´ ã®å®£è¨€ (DOMContentLoadedå¤–ã§å®£è¨€)
        var namesTextarea, weightsTextarea, wheel, spinButton, resultDisplay, wheelContainer, currentSizeDisplay, resetButton;

        var participants = [];
        var totalWeight = 0;
        var isSpinning = false;
        var drawnParticipants = []; // ğŸ† å½“é¸è€…å±¥æ­´ã‚’ç®¡ç†

        var spinSound = null;
        var winSound = null;

        // è‰²ã®ãƒªã‚¹ãƒˆï¼ˆ50åã¾ã§å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«å¤šã‚ã«ç”¨æ„ï¼‰
        var colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
            '#A3E4D7', '#F5B7B1', '#85C1E9', '#A9CCE3', '#F9E79F', '#D7BDE2', '#EDBB99',
            '#A9A9A9', '#7D3C98', '#27AE60', '#F1C40F', '#E67E22', '#3498DB', '#95A5A6',
            '#1ABC9C', '#D35400', '#2C3E50', '#7F8C8D', '#9B59B6', '#F39C12', '#2ECC71',
            '#C0392B', '#E6B0AA', '#D5F5E3', '#FCF3CF', '#A9DFBF', '#FADBD8', '#BB8FCE',
            '#D6EAF8', '#A2D9CE', '#F9EBB9', '#F0B27A', '#CCD1D1', '#76448A', '#2E86C1',
            '#27AE60', '#F1C40F', '#E67E22', '#3498DB', '#95A5A6', '#1ABC9C', '#D35400', '#2C3E50'
        ];
        var colorIndex = 0;

        /**
         * èƒŒæ™¯è‰²ã«å¿œã˜ã¦ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆç™½ã¾ãŸã¯é»’ï¼‰ã‚’é¸æŠã™ã‚‹
         */
        var getContrastColor = (hexcolor) => {
            var r = parseInt(hexcolor.slice(1, 3), 16);
            var g = parseInt(hexcolor.slice(3, 5), 16);
            var b = parseInt(hexcolor.slice(5, 7), 16);
            
            // è¼åº¦ (Luminance) ã®è¨ˆç®—
            var luminance = (0.299 * r + 0.587 * g + 0.114 * b + 0.1) / 255;
            
            // è¼åº¦ãŒ0.5ã‚ˆã‚Šå¤§ãã‘ã‚Œã°ï¼ˆæ˜ã‚‹ã‘ã‚Œã°ï¼‰é»’ã€ãã†ã§ãªã‘ã‚Œã°ç™½
            return (luminance > 0.5) ? '#000000' : '#ffffff';
        };
        
        // --- Tone.js ã‚µã‚¦ãƒ³ãƒ‰è¨­å®šã¨åˆ¶å¾¡ (Tone.jsãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ) ---
        var drumRoll = null;

        var initToneJs = () => {
            if (typeof Tone === 'undefined') {
                console.warn("Tone.js is not loaded. Sound effects will be disabled.");
                return;
            }
            
            // ğŸ¼ ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«éŸ³ (æ˜ã‚‹ã„ãƒãƒ£ã‚¤ãƒ )
            spinSound = new Tone.Synth({ 
                oscillator: { type: "triangle" }, 
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.1
                }
            }).toDestination();
            
            // å‹åˆ©éŸ³
            winSound = new Tone.PolySynth(Tone.AMSynth).toDestination();
        };

        /**
         * ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã®è¨­å®šã¨é–‹å§‹
         */
        var startDrumRoll = (duration) => {
            if (typeof Tone === 'undefined') return;
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾ç­–ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰æ™‚ã«AudioContextã‚’å†é–‹
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }

            // ãƒ«ãƒ¼ãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯åœæ­¢ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (drumRoll) {
                drumRoll.dispose();
            }
            
            // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã®éŸ³ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®š (é«˜ã‚ã®æ˜ã‚‹ã„éŸ³ G4)
            drumRoll = new Tone.Loop(function(time) {
                if (spinSound) spinSound.triggerAttackRelease("G4", "16n", time); // G4ã§æ˜ã‚‹ã„ãƒãƒ£ã‚¤ãƒ éŸ³
            }, "16n").start(0); 

            Tone.Transport.bpm.value = 160;
            Tone.Transport.start(); // BGMãŒãªã„ãŸã‚ã€ã“ã“ã§ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹
        };
        
        /**
         * ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã®åœæ­¢ã¨å‹åˆ©éŸ³
         */
        var stopDrumRollAndPlayWin = () => {
            if (typeof Tone === 'undefined') return;

            if (drumRoll) {
                drumRoll.stop();
                drumRoll.dispose();
                drumRoll = null;
            }
            
            // ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚’åœæ­¢
            Tone.Transport.stop();
            
            // å‹åˆ©ã®ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬
            if (winSound) winSound.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1.5");
        };


        // --- ã‚µã‚¤ã‚ºèª¿æ•´æ©Ÿèƒ½ ---

        /**
         * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°ã™ã‚‹
         */
        var updateWheelSize = (size) => {
            wheelContainer.style.width = size + 'px';
            wheelContainer.style.height = size + 'px';
            currentSizeDisplay.textContent = size + 'px';
        };


        // --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ ---

        /**
         * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®æº–å‚™: å…¥åŠ›å€¤ã®è§£æã¨ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®æç”»
         */
        var prepareWheel = () => {
            // DOMè¦ç´ ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ (WordPresså¯¾ç­–)
            if (!namesTextarea || !weightsTextarea || !wheel) {
                console.error("DOM elements not found during prepareWheel.");
                return;
            }

            if (isSpinning) return;
            
            var nameLines = namesTextarea.value.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);
            var weightLines = weightsTextarea.value.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);

            if (nameLines.length === 0 || weightLines.length === 0 || nameLines.length !== weightLines.length) {
                resultDisplay.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: åå‰ã¨å€ç‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã€æ•°ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                resultDisplay.classList.remove('text-green-600', 'result-animate');
                resultDisplay.classList.add('text-red-500');
                spinButton.disabled = true;
                wheel.style.backgroundImage = 'none';
                wheel.innerHTML = '';
                return;
            }

            participants = [];
            totalWeight = 0;
            colorIndex = 0;

            for (var i = 0; i < nameLines.length; i++) {
                var name = nameLines[i];
                var weight = parseInt(weightLines[i], 10); 
                
                if (name && weight > 0) {
                    participants.push({
                        name: name,
                        weight: weight,
                        color: colors[colorIndex % colors.length], 
                        startAngle: 0,
                        endAngle: 0
                    });
                    totalWeight += weight;
                    colorIndex++;
                }
            }

            if (participants.length === 0) {
                resultDisplay.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªå‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ï¼ˆåå‰ã¨æ­£ã®å€ç‡ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                spinButton.disabled = true;
                wheel.style.backgroundImage = 'none';
                wheel.innerHTML = '';
                return;
            }

            drawWheel();
            spinButton.disabled = false;
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç½®ãæ›ãˆ
            resultDisplay.textContent = 'âœ… ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæº–å‚™å®Œäº†ï¼ç·å€ç‡: ' + totalWeight;
            resultDisplay.classList.remove('text-red-500', 'result-animate', 'text-gray-700');
            resultDisplay.classList.add('text-green-600');
            // æº–å‚™å®Œäº†æ™‚ã«æŠ½é¸æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('resetButton').disabled = drawnParticipants.length === 0;
        };

        /**
         * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’Conic Gradientã§æç”»ã—ã€ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå†…ã«ãƒ©ãƒ™ãƒ«ã‚’é…ç½®ã™ã‚‹
         */
        var drawWheel = () => {
            var gradientString = 'conic-gradient(';
            var currentPercent = 0;
            wheel.innerHTML = ''; 

            participants.forEach(p => {
                var percent = (p.weight / totalWeight) * 100;
                var start = currentPercent;
                var end = currentPercent + percent;
                
                p.startAngle = start * 3.6;
                p.endAngle = end * 3.6;     

                gradientString += p.color + ' ' + start + '% ' + end + '%, ';
                
                currentPercent = end;

                // 2. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå†…ã®ãƒ©ãƒ™ãƒ«ã‚’é…ç½®
                var centerAngle = (p.startAngle + p.endAngle) / 2;
                
                var labelContainer = document.createElement('div');
                labelContainer.className = 'label-container';
                labelContainer.style.transform = 'rotate(' + (centerAngle - 90) + 'deg)'; 
                
                var textElement = document.createElement('div');
                textElement.className = 'wheel-label-text flex items-center justify-start pointer-events-none';
                
                // è·é›¢ã‚’70ã«å¢—ã‚„ã—ã¦ã€å¤–å´ã¸é…ç½®
                var distance = 70; 
                var rotateBack = 90 - centerAngle;
                textElement.style.transform = 'translateY(-50%) translateX(' + distance + '%) rotate(' + rotateBack + 'deg)';
                
                textElement.style.color = getContrastColor(p.color);
                
                var nameDisplay = p.name.length > 8 ? p.name.substring(0, 8) + '...' : p.name; 
                // å€ç‡è¡¨è¨˜ã‚’å‰Šé™¤ã—ã€ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ text-xs ã«å¤‰æ›´
                textElement.innerHTML = '<span class="text-xs font-bold leading-tight" style="background-color: rgba(255, 255, 255, 0.2); padding: 2px 4px; border-radius: 4px;">' + nameDisplay + '</span>';

                labelContainer.appendChild(textElement);
                wheel.appendChild(labelContainer);
            });

            // 3. CSSã«é©ç”¨
            gradientString = gradientString.slice(0, -2) + ')';
            wheel.style.backgroundImage = gradientString;
            wheel.style.transform = 'rotate(0deg)';
        };

        /**
         * æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯: é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ (æœªå½“é¸è€…ã‹ã‚‰é¸ã¶)
         */
        var selectWinner = () => {
            // ğŸ† æœªå½“é¸è€…ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            var availableParticipants = participants.filter(p => drawnParticipants.indexOf(p.name) === -1);

            if (availableParticipants.length === 0) {
                return null; // å…¨å“¡å½“é¸æ¸ˆ
            }

            // æœªå½“é¸è€…ã®ã¿ã®ç·å€ç‡
            var availableTotalWeight = availableParticipants.reduce(function(sum, p) { return sum + p.weight; }, 0);
            var randomValue = Math.random() * availableTotalWeight;
            var cumulativeWeight = 0;

            for (var i = 0; i < availableParticipants.length; i++) {
                var p = availableParticipants[i];
                cumulativeWeight += p.weight;
                if (randomValue < cumulativeWeight) {
                    return p;
                }
            }
            return availableParticipants[availableParticipants.length - 1]; 
        };

        /**
         * ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å›è»¢ã‚’é–‹å§‹ã™ã‚‹
         */
        var spinWheel = () => {
            if (isSpinning) return;
            if (participants.length < 1) {
                resultDisplay.textContent = 'âŒ å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’æº–å‚™ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
                resultDisplay.classList.add('text-red-500');
                return;
            }

            // ğŸ† æœªå½“é¸è€…ã‹ã‚‰é¸æŠ
            var winner = selectWinner(); 

            if (!winner) {
                // å…¨å“¡å½“é¸æ¸ˆã¿ã®å‡¦ç†
                resultDisplay.textContent = 'âš ï¸ å…¨å“¡ãŒå½“é¸ã—ã¾ã—ãŸï¼ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚';
                resultDisplay.classList.remove('text-gray-700', 'result-animate');
                resultDisplay.classList.add('text-red-500');
                spinButton.disabled = false;
                isSpinning = false;
                return;
            }


            isSpinning = true;
            spinButton.disabled = true;
            
            // 1. å›è»¢ä¸­ã¯æœŸå¾…æ„Ÿã‚’ç…½ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç½®ãæ›ãˆ
            resultDisplay.textContent = 'ğŸ¯ æœãŸã—ã¦ã€æ „å…‰ã‚’æ´ã‚€ã®ã¯èª°ã ï¼ï¼Ÿ å›è»¢ä¸­ï¼';
            resultDisplay.classList.remove('text-red-500', 'text-green-600', 'result-animate');
            resultDisplay.classList.add('text-gray-700'); // å›è»¢ä¸­ã®è‰²
            
            // --- ä¿®æ­£ç‚¹: å›è»¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å¸¸ã«åŒã˜æŒ™å‹•ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ ---
            wheel.style.transitionDuration = '0s'; // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
            wheel.style.transform = 'rotate(0deg)'; // å›è»¢ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
            void wheel.offsetWidth; // å¼·åˆ¶çš„ã«DOMå†æç”»ã‚’å¾…ã¤

            // 2. æ–°ã—ã„å›è»¢æ™‚é–“ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š (4ç§’ã‹ã‚‰7ç§’ã®é–“)
            var spinDuration = Math.random() * 3 + 4; // 4.0 ~ 6.99...ç§’
            wheel.style.transitionDuration = spinDuration + 's'; 
            // -----------------------------------------------------------------

            // 3. ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã‚’é–‹å§‹
            startDrumRoll(spinDuration);

            
            // ã©ã®åŒºç”»ã«æ­¢ã¾ã‚‹ã‹è¨ˆç®—
            var target = participants.find(p => p.name === winner.name);
            var targetAngle = (target.startAngle + target.endAngle) / 2;
            
            var offset = 360 - targetAngle; 
            var minRotations = 5; 
            var finalRotation = (minRotations * 360) + offset + (Math.random() * 30 - 15); 
            
            wheel.style.transform = 'rotate(' + finalRotation + 'deg)';

            // 4. å›è»¢æ™‚é–“ã«åˆã‚ã›ã¦çµæœã‚’è¡¨ç¤º
            setTimeout(function() {
                stopDrumRollAndPlayWin(); // ãƒ‰ãƒ©ãƒ ãƒ­ãƒ¼ãƒ«ã‚’åœæ­¢ã—ã€å‹åˆ©éŸ³ã‚’å†ç”Ÿ
                
                isSpinning = false;
                spinButton.disabled = false;
                
                // ğŸ† å½“é¸è€…ã‚’å±¥æ­´ã«è¿½åŠ 
                drawnParticipants.push(winner.name);
                updateWinnerHistory(winner); // å±¥æ­´æ›´æ–°
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç½®ãæ›ãˆ
                resultDisplay.textContent = 'ğŸ‰ å½“é¸è€…ã¯... ' + winner.name + ' ã§ã™ï¼'; // æœ€çµ‚çµæœ
                resultDisplay.classList.remove('text-gray-700', 'text-green-600');
                resultDisplay.classList.add('text-red-500', 'result-animate');
            }, spinDuration * 1000); // ãƒŸãƒªç§’ã«å¤‰æ›
        };
        
        /**
         * ğŸ† å½“é¸è€…ãƒªã‚¹ãƒˆã‚’UIã«æ›´æ–°ã™ã‚‹
         */
        var updateWinnerHistory = (newWinner) => {
            var historyList = document.getElementById('winnerHistory');
            var resetBtn = document.getElementById('resetButton');

            // ãƒªã‚¹ãƒˆã«æ–°ã—ã„å½“é¸è€…ã‚’è¿½åŠ 
            var listItem = document.createElement('li');
            var winnerInfo = participants.find(p => p.name === newWinner.name);
            // å½“é¸è€…ã«è‰²ã‚’ä»˜ã‘ã¦è¦‹ã‚„ã™ãã™ã‚‹
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç½®ãæ›ãˆ
            listItem.innerHTML = '<span style="color: ' + winnerInfo.color + '; font-weight: bold;">' + winnerInfo.name + '</span> ãŒå½“é¸ã—ã¾ã—ãŸï¼(å€ç‡: ' + winnerInfo.weight + ')';
            historyList.appendChild(listItem);
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            if (drawnParticipants.length > 0) {
                resetBtn.disabled = false;
            }
        };

        /**
         * ğŸ† å½“é¸è€…ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
         */
        var resetLottery = () => {
            drawnParticipants = [];
            document.getElementById('winnerHistory').innerHTML = '';
            document.getElementById('resetButton').disabled = true;
            
            // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’å†æç”»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            prepareWheel(); 
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç½®ãæ›ãˆ
            resultDisplay.textContent = 'ğŸ‰ æŠ½é¸ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€å…¨å“¡ãŒæŠ½é¸å¯¾è±¡ã«æˆ»ã‚Šã¾ã—ãŸï¼';
            resultDisplay.classList.remove('text-red-500', 'result-animate');
            resultDisplay.classList.add('text-green-600');
        };


        /**
         * ğŸ–¼ï¸ èƒŒæ™¯ã«å‹•ç‰©ã®çµµæ–‡å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®ã™ã‚‹
         */
        var addRandomEmojis = () => {
            var emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ¾', 'âœ¨', 'ğŸ’–', 'â­', 'ğŸˆ', 'ğŸ', 'ğŸ€'];
            var count = 35; // 20ã‹ã‚‰35ã«å¢—åŠ ã—ã¦ãƒãƒ©ãƒ³ã‚¹æ”¹å–„

            for (var i = 0; i < count; i++) {
                var emoji = document.createElement('span');
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                
                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½® (vh/vw: ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•/å¹…ã«å¯¾ã™ã‚‹ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸)
                var top = Math.random() * 100; // 0% to 100%
                var left = Math.random() * 100; // 0% to 100%
                var rotation = Math.random() * 360; 

                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚µã‚¤ã‚º (25px to 40px)
                var size = Math.random() * 15 + 25; 

                emoji.style.position = 'fixed';
                emoji.style.top = top + 'vh';
                emoji.style.left = left + 'vw';
                emoji.style.fontSize = size + 'px';
                emoji.style.opacity = Math.random() * 0.4 + 0.3; // 0.3 to 0.7 opacity
                emoji.style.transform = 'rotate(' + rotation + 'deg)';
                emoji.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ãŒä¸‹ã®è¦ç´ ã«å±Šãã‚ˆã†ã«
                emoji.style.userSelect = 'none';
                emoji.style.zIndex = '-1'; // æœ€èƒŒé¢
                
                document.body.appendChild(emoji);
            }
        };

        // åˆæœŸè¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            
            try {
                // 1. DOMè¦ç´ ã®å–å¾—
                namesTextarea = document.getElementById('names');
                weightsTextarea = document.getElementById('weights');
                wheel = document.getElementById('wheel');
                spinButton = document.getElementById('spinButton');
                resultDisplay = document.getElementById('result');
                wheelContainer = document.getElementById('wheelContainer');
                currentSizeDisplay = document.getElementById('currentSize');
                resetButton = document.getElementById('resetButton');

                // 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š (onclickå±æ€§ã‚’å‰Šé™¤ã—ãŸä»£ã‚ã‚Šã«ã€ã“ã“ã§å‹•çš„ã«è¨­å®š)
                document.getElementById('prepareButton').addEventListener('click', prepareWheel);
                spinButton.addEventListener('click', spinWheel);
                resetButton.addEventListener('click', resetLottery);
                
                var sizeSlider = document.getElementById('sizeSlider');
                sizeSlider.addEventListener('input', function(e) { updateWheelSize(e.target.value); });

                // 3. Tone.jsã®åˆæœŸåŒ–
                initToneJs();

                // 4. ãƒ©ãƒ³ãƒ€ãƒ ãªçµµæ–‡å­—ã®é…ç½®
                addRandomEmojis(); 

                // 5. ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®åˆæœŸè¨­å®š (åˆæœŸãƒ‡ãƒ¼ã‚¿ã§æç”»)
                prepareWheel(); 
                
                console.log("Roulette App: Initialization complete and listeners attached. Final structural fix applied.");
                
            } catch (e) {
                console.error("Roulette App Initialization Error (FATAL):", e);
                if (resultDisplay) {
                    resultDisplay.textContent = 'è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    resultDisplay.classList.add('text-red-500');
                }
            }
        });
    </script>
</body>
</html>
